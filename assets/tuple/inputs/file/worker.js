function t(){}
function e(t,e){this.song=new i.Song(t),this.notify=e;try{this.song.load()}catch(n){return this.notify("end",n.message)}this.timeDivision=this.song.header.resolution,this.tempo=5e5,this.tempoRate=1,this.pause=!1,this.resume=-1,this.track=this.song.mergeTracks(),this.length=this.track.length,this.position=0,this.totalTime=this.song.getTotalTime(),this.notify("length",this.totalTime)}
var i=function(){
  var t=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},
      e={};
  e.dataViewGetSubDataView=function(t,e,i){return"undefined"==typeof i&&(i=t.byteLength-e),new DataView(t.buffer,t.byteOffset+e,i)},
  e.dataViewGetUint=function(t,e,i,n){var a=0;if("undefined"==typeof n&&(n=t.byteLength-e),i)for(var r=n-1;r>=0;--r)a=(a<<8)+t.getUint8(e+r);else for(var r=0;n>r;++r)a=(a<<8)+t.getUint8(e+r);return a},
  e.dataViewGetUintVariable=function(t,e){for(var i=0,n=0;;){var a=t.getUint8(e+n);++n;var r=128&a,o=127&a;if(i=(i<<7)+o,!r)break}return{value:i,byteLength:n}};
  var i=function(){function t(t,e,i){this.dataView=t,this.tick=e,this.status=i}return t.prototype.toWebMidiLinkString=function(){for(var t=[this.status],e=0;e<this.dataView.byteLength;++e)t.push(this.dataView.getUint8(e));return"midi,"+t.map(function(t){return t.toString(16)}).join(",")},t.create=function(t,e,i){this.statusEventMap||(this.statusEventMap={128:a,144:r,160:o,176:s,192:u,208:c,224:f,240:h,255:d});var n=240&i;if(255===i)return d.create(t,e,i);if(144===i&&0===t.getUint8(1))return new a(t,e,128);var p=this.statusEventMap[n];return new p(t,e,i)},Object.defineProperty(t.prototype,"statusType",{get:function(){return 240&this.status},enumerable:!0,configurable:!0}),t}(),
  n=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"channel",{get:function(){return 15&this.status},enumerable:!0,configurable:!0}),i}(i),
  a=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"noteNumber",{get:function(){return this.dataView.getUint8(0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"velocity",{get:function(){return this.dataView.getUint8(1)},enumerable:!0,configurable:!0}),i}(n),
  r=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"noteNumber",{get:function(){return this.dataView.getUint8(0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"velocity",{get:function(){return this.dataView.getUint8(1)},enumerable:!0,configurable:!0}),i}(n),
  o=function(e){function i(){e.apply(this,arguments)}return t(i,e),i}(n),
  s=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"controller",{get:function(){return this.dataView.getUint8(0)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"value",{get:function(){return this.dataView.getUint8(1)},enumerable:!0,configurable:!0}),i}(n),
  u=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"program",{get:function(){return this.dataView.getUint8(0)},enumerable:!0,configurable:!0}),i}(n),
  c=function(e){function i(){e.apply(this,arguments)}return t(i,e),i}(n),
  f=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"value",{get:function(){return this.dataView.getUint8(0)+(this.dataView.getUint8(1)<<7)-8192},enumerable:!0,configurable:!0}),i}(n),
  p=function(e){function i(){e.apply(this,arguments)}return t(i,e),Object.defineProperty(i.prototype,"statusType",{get:function(){return this.status},enumerable:!0,configurable:!0}),i}(i),
  h=function(e){function i(){e.apply(this,arguments)}return t(i,e),i}(p),
  d=function(i){function n(){i.apply(this,arguments)}return t(n,i),n.create=function(t,e,i){this.typeIndexEventMap||(this.typeIndexEventMap={81:l});var a=t.getUint8(0);if(a in this.typeIndexEventMap){var r=this.typeIndexEventMap[a];return new r(t,e,i)}return new n(t,e,i)},Object.defineProperty(n.prototype,"typeIndex",{get:function(){return this.dataView.getUint8(0)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"data",{get:function(){var t=e.dataViewGetUintVariable(this.dataView,1),i=t.value,n=t.byteLength;return e.dataViewGetSubDataView(this.dataView,1+n,i)},enumerable:!0,configurable:!0}),n}(p),
  l=function(i){function n(){i.apply(this,arguments)}return t(n,i),Object.defineProperty(n.prototype,"rawTempo",{get:function(){return e.dataViewGetUint(this.data,0,!1)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"secondsPerBeat",{get:function(){return 1e-6*this.rawTempo},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"beatsPerMinute",{get:function(){return 60/this.secondsPerBeat},enumerable:!0,configurable:!0}),n}(d),
  y=function(){function t(t,e,i,n){this.dataView=t,this.name=e,this.formType=i,this.config=n}function e(t,e,i){var n=new Uint8Array(t.buffer,t.byteOffset+e,i);return String.fromCharCode.apply(null,n)}return t.prototype.load=function(){this.children=[];for(var i=0;i<this.dataView.byteLength;){var n=e(this.dataView,i,4);i+=4;var a=this.dataView.getUint32(i,!this.config.bigEndian);i+=4;var r=new DataView(this.dataView.buffer,this.dataView.byteOffset+i,a),o=void 0;if(this.config.recursive&&-1!=this.config.recursive.indexOf(n)){var s=e(r,0,4),u=new DataView(this.dataView.buffer,this.dataView.byteOffset+i+4,a-4);o=new t(u,n,s,this.config),o.load()}else o=new t(r,n,null,this.config);this.children.push(o),i+=a,this.config.allowOddOffset||i%2!=1||++i}},t}();
  XIFF={},
  XIFF.Chunk=y,
  XIFF.RIFF={recursive:["RIFF","LIST"]},
  XIFF.IFF={bigEndian:!0,recursive:["FORM","LIST","CAT "]},
  XIFF.SMF={bigEndian:!0,allowOddOffset:!0},
  XIFF.load=function(t,e){var i=new DataView(t),n=new y(i,null,null,e);return n.load(),n};
  var g=function(){function t(t){this.dataView=t}return t.prototype.load=function(){var t=0;this.format=this.dataView.getUint16(t,!1),t+=2,this.numberOfTracks=this.dataView.getUint16(t,!1),t+=2,this.resolution=this.dataView.getUint16(t,!1)},t}(),
  m=function(){function t(t){this.dataView=t}return t.prototype.build=function(t,n,a){var r=0;switch(240&n){case 128:case 144:case 160:case 224:r=2;break;case 176:r=2;break;case 192:case 208:r=1;break;case 240:if(255==n){var o=e.dataViewGetUintVariable(this.dataView,a+1),s=o.byteLength,u=o.value;r=1+s+u}else{var c=e.dataViewGetUintVariable(this.dataView,a),s=c.byteLength,u=c.value;r=s+u}}var f=new DataView(this.dataView.buffer,this.dataView.byteOffset+a,r);return i.create(f,t,n)},t}(),
  w=function(){function t(t){this.dataView=t}return t.prototype.load=function(){var t=0,i=0,n=0,a=new m(this.dataView);for(this.events=[];t<this.dataView.byteLength;){var r=e.dataViewGetUintVariable(this.dataView,t),o=r.byteLength,s=r.value;t+=o,i+=s;var u=this.dataView.getUint8(t),c=128&u;c&&(n=u,++t);var f=a.build(i,n,t);t+=f.dataView.byteLength,this.events.push(f)}},t}(),
  b=function(){function t(t){this.buffer=t}return t.prototype.load=function(){var t=this,e=XIFF.load(this.buffer,XIFF.SMF);this.tracks=[],e.children.forEach(function(e){switch(e.name){case"MThd":t.header=new g(e.dataView),t.header.load();break;case"MTrk":var i=new w(e.dataView);i.load(),t.tracks.push(i)}})},t.prototype.mergeTracks=function(){var t=[];return this.tracks.forEach(function(e,i){e.events.forEach(function(e,n){t.push({track:i,eventId:n,time:e.tick,event:e})})}),t.sort(function(t,e){return t.time>e.time?1:t.time<e.time?-1:t.track>e.track?1:t.track<e.track?-1:t.eventId>e.eventId?1:t.eventId<e.eventId?-1:0}),this.mergedTrack=t,this.mergedTrack},t.prototype.getTotalTime=function(t){if(!this.header)throw new Error("Please load first!");var e,i=t||5e5,n=this.header.resolution,a=0;return this.mergedTrack||this.mergeTracks(),this.mergedTrack.forEach(function(t,r){t.event instanceof l&&(i=t.event.rawTempo),delta=e?t.time-e:t.time,a+=i/(1e3*n)*delta,e=t.time}),a},t}();
  return{
    Song:b,
    TempoMetaEvent:l
  }
}();
e.prototype.setTempoRate=function(t){this.tempoRate=t},
e.prototype.play=function(){this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.started_at=Date.now()/1e3,this.playSequence()},
e.prototype.skip=function(e){t("Skipping "+e+" ticks from "+this.position),this.position+=e},
e.prototype.playSequence=function(){function e(){return r.tempo/(1e3*r.timeDivision)*(1/r.tempoRate)}function n(){var c,f,p=r.position,h=o[p].time,d=o.length,l=Date.now(),y=[];if(r.pause)return void(r.resume=Date.now()-r.resume);do{c=o[p].event,f=o[p-1]?o[p].time-o[p-1].time:o[p].time,u+=s/1e3*f,c instanceof i.TempoMetaEvent&&(r.tempo=c.rawTempo,s=e(),t("Updated tempo!",r.tempo,r.timeDivision),r.notify("tempo",6e7/c.rawTempo));for(var g=[c.status],m=0;m<c.dataView.byteLength;++m)g.push(c.dataView.getUint8(m));g[0]==y[0]&&g[1]==y[1]&&g[2]==y[2]?t("Duplicate event!",g):r.notify("midi_event",{raw:g}),p++,y=g}while(d>p&&o[p].time===h);if(d>p){l=Date.now()-l,f=o[p].time-h;var w=Date.now()/1e3-r.started_at,b=w-u;t(w,u,b),a=s*f-(l+1e3*b),r.timer=setTimeout(n,a)}else r.finished();r.position=p}var a,r=this,o=this.track,s=e(),u=0;if(this.pause)this.timer=setTimeout(n,this.resume),this.pause=!1,this.resume=-1;else{var a=this.tempo/1e3*this.timeDivision*this.track[0].time;this.timer=setTimeout(n,a)}},
e.prototype.stop=function(){this.pause=!0,this.resume=Date.now()},
e.prototype.finished=function(){var e=Date.now()/1e3-this.started_at;t("Song finished. Seconds taken: ",e),this.track=[],this.song=null,this.notify("end")};
var n={};
n.play=function(t){this.player=new e(t,this.notify),this.player.play()},
n.notify=function(t,e){var i={event:t};e&&(i.data=e),self.postMessage(i)},
self.addEventListener("message",function(e){var i=e.data;switch(t("Got command on worker: "+i.action),i.action){case"play":n.play(i.data);break;case"pause":n.player&&n.player.pause();break;case"stop":n.player&&n.player.stop();break;case"forward":n.player&&n.player.skip(1e3);break;case"previous":n.player&&n.player.skip(-1e3);break;case"kill":self.close();break;default:t("Unknown command on worker:"+i.action),n.notify("error",{message:"Unknown command: "+i.action})}},!1);